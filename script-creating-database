/*Script for creating the database*/

CREATE TABLE person (
    id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY NOT NULL,
    personal_number VARCHAR(12) UNIQUE,
    first_name VARCHAR(15),
    last_name VARCHAR(25),
    street VARCHAR(50),
    zip VARCHAR(6),
    city VARCHAR(100)
);

CREATE TABLE employee (
    id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY NOT NULL,
    salary VARCHAR(6),
    supervisor VARCHAR(30),
    person_id INT NOT NULL,
    department_id INT NOT NULL,
    job_title_id INT NOT NULL
);

CREATE TABLE department (
    id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY NOT NULL,
    department_name VARCHAR(20) UNIQUE,
    manager VARCHAR(30)
);

CREATE TABLE job_title (
    id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY NOT NULL,
    job_title VARCHAR(30) UNIQUE NOT NULL
);

CREATE TABLE course_layout (
    id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY NOT NULL,
    course_code VARCHAR(10) UNIQUE,
    course_name VARCHAR(10),
    min_students INT,
    max_students INT,
    hp NUMERIC
);

CREATE TYPE academic_period AS ENUM ('P1', 'P2', 'P3', 'P4');

CREATE TABLE course_instance (
    id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY NOT NULL,
    instance_id VARCHAR(10) UNIQUE,
    study_period academic_period NOT NULL,
    study_year VARCHAR(4),
    num_students INT,
    course_layout_id INT NOT NULL
);

CREATE TABLE teaching_activity (
    id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY NOT NULL,
    activity_name VARCHAR(20) UNIQUE,
    factor NUMERIC
);

CREATE TABLE planned_activity (
    id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY NOT NULL,
    planned_hours VARCHAR(3) NOT NULL,
    course_instance_id INT NOT NULL,
    teaching_activity_id INT NOT NULL
);

CREATE TABLE phone_number (
    id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY NOT NULL,
    phone_num VARCHAR(15) UNIQUE NOT NULL
);

CREATE TABLE skill_set (
    id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY NOT NULL,
    skill_category VARCHAR(20),
    skill_description VARCHAR(100)
);

ALTER TABLE course_instance
ADD CONSTRAINT fk_course_layout_id
    FOREIGN KEY (course_layout_id)
    REFERENCES course_layout(id);

ALTER TABLE planned_activity
ADD CONSTRAINT fk_course_instance_id
    FOREIGN KEY (course_instance_id) REFERENCES course_instance(id),
ADD CONSTRAINT fk_teaching_activity_id
    FOREIGN KEY (teaching_activity_id) REFERENCES teaching_activity(id);

ALTER TABLE employee
ADD CONSTRAINT fk_person_id
    FOREIGN KEY (person_id) REFERENCES person(id),
ADD CONSTRAINT fk_department_id
    FOREIGN KEY (department_id) REFERENCES department(id),
ADD CONSTRAINT fk_job_title_id
    FOREIGN KEY (job_title_id) REFERENCES job_title(id);

CREATE TABLE employee_planned_activity (
    planned_activity_id INT NOT NULL,
    employee_id INT NOT NULL,
    PRIMARY KEY (planned_activity_id, employee_id),
    FOREIGN KEY (planned_activity_id) REFERENCES planned_activity(id),
    FOREIGN KEY (employee_id) REFERENCES employee(id)
);

CREATE TABLE employee_skill_set (
    skill_set_id INT NOT NULL,
    employee_id INT NOT NULL,
    PRIMARY KEY (skill_set_id, employee_id),
    FOREIGN KEY (skill_set_id) REFERENCES skill_set(id),
    FOREIGN KEY (employee_id) REFERENCES employee(id)
);

/*Views to create for seminar 2. Explained in file script-queries-seminar-2 and should only be run once. They are shown in the other file only for submission purposes*/

CREATE VIEW admin_exam_hours AS
SELECT
   instance.instance_id,
   layout.hp,
   instance.num_students,
   instance.study_year,
   instance.study_period,
   (32 + 0.725* num_students) AS examination_hours,
   (2 * hp + 28 + 0.2* num_students) AS administration_hours
FROM course_instance AS instance
JOIN course_layout AS layout ON instance.course_layout_id = layout.id;

CREATE VIEW factored_hours_per_activity AS
SELECT
   instance.instance_id,
   teaching.activity_name,
   SUM(planned.planned_hours::numeric * teaching.factor::numeric) AS factored_hours
FROM planned_activity AS planned
JOIN course_instance AS instance ON planned.course_instance_id = instance.id
JOIN teaching_activity AS teaching ON planned.teaching_activity_id = teaching.id
WHERE instance.study_year = '2025'
GROUP BY
   instance.instance_id,
   teaching.activity_name;

CREATE VIEW instance_activity_hours_2025 AS
SELECT 
   layout.course_code,
   factor.instance_id,
   admin.hp AS hp,
   admin.num_students AS number_of_students,
   admin.study_period AS period,
   SUM(CASE WHEN factor.activity_name = 'Lecture' THEN factor.factored_hours ELSE 0 END) AS lecture_hours,
   SUM(CASE WHEN factor.activity_name = 'Lab' THEN factor.factored_hours ELSE 0 END) AS lab_hours,
   SUM(CASE WHEN factor.activity_name = 'Seminar' THEN factor.factored_hours ELSE 0 END) AS seminar_hours,
   SUM(CASE WHEN factor.activity_name = 'Tutorial' THEN factor.factored_hours ELSE 0 END) AS tutorial_hours,
   admin.examination_hours,
   admin.administration_hours,
   SUM (factor.factored_hours) + admin.examination_hours + admin.administration_hours AS total_hours
FROM factored_hours_per_activity AS factor
JOIN admin_exam_hours AS admin ON admin.instance_id = factor.instance_id
JOIN course_instance AS instance ON instance.instance_id = factor.instance_id
JOIN course_layout AS layout ON instance.course_layout_id = layout.id
GROUP BY 
   layout.course_code,
   factor.instance_id,
   admin.hp,
   admin.num_students,
   admin.study_period,
   admin.examination_hours,
   admin.administration_hours;

CREATE VIEW employee_title_and_name AS
SELECT
    employee.id AS employee_id,
    person.first_name || ' ' || person.last_name AS employee_name,
    job_title.job_title
FROM employee 
JOIN person ON employee.person_id = person.id
JOIN job_title ON employee.job_title_id = job_title.id;

CREATE VIEW factored_hours_per_employee AS
SELECT
    instance.instance_id,
    layout.hp,
    employee_title_name.employee_name,
    employee_title_name.job_title,
    activity.activity_name,
    SUM(planned.planned_hours::numeric * activity.factor::numeric) AS factored_hours
FROM planned_activity AS planned
JOIN course_instance AS instance ON planned.course_instance_id = instance.id
JOIN course_layout AS layout ON instance.course_layout_id = layout.id
JOIN teaching_activity AS activity ON planned.teaching_activity_id = activity.id
JOIN employee_planned_activity AS employee_planned ON planned.id = employee_planned.planned_activity_id
JOIN employee_title_and_name AS employee_title_name ON employee_title_name.employee_id = employee_planned.employee_id
WHERE instance.study_year = '2025'
GROUP BY
    instance.instance_id,
    layout.hp,
    employee_title_name.employee_name,
    employee_title_name.job_title,
    activity.activity_name;

CREATE VIEW eligible_teacher_count AS 
SELECT 
   admin.instance_id, 
   COUNT(DISTINCT employee.id) AS num_teachers
FROM admin_exam_hours AS admin 
JOIN course_instance AS instance ON instance.instance_id = admin.instance_id 
JOIN planned_activity AS planned ON planned.course_instance_id = instance.id 
JOIN employee_planned_activity AS employee_planned ON employee_planned.planned_activity_id = planned.id 
JOIN employee ON employee.id = employee_planned.employee_id 
JOIN job_title ON job_title.id = employee.job_title_id 
WHERE job_title.job_title IN ('Lecturer', 'Senior Lecturer', 'Professor') 
GROUP BY admin.instance_id;

CREATE VIEW activity_hours_per_employee AS
SELECT
   layout.course_code,
   factor.instance_id,
   factor.hp,
   admin.study_period AS period,
   factor.employee_name,
   factor.job_title,
   SUM(CASE WHEN factor.activity_name = 'Lecture' THEN factor.factored_hours ELSE 0 END) AS lecture_hours,
   SUM(CASE WHEN factor.activity_name = 'Tutorial' THEN factor.factored_hours ELSE 0 END) AS tutorial_hours,
   SUM(CASE WHEN factor.activity_name = 'Lab' THEN factor.factored_hours ELSE 0 END) AS lab_hours,
   SUM(CASE WHEN factor.activity_name = 'Seminar' THEN factor.factored_hours ELSE 0 END) AS seminar_hours,
   CASE WHEN factor.job_title IN ('Lecturer', 'Senior Lecturer', 'Professor') THEN ROUND(admin.administration_hours / eligible.num_teachers, 2) ELSE 0 END AS admin,
   CASE WHEN factor.job_title IN ('Lecturer', 'Senior Lecturer', 'Professor') THEN ROUND(admin.examination_hours / eligible.num_teachers, 2) ELSE 0 END AS exam,
   ROUND(
   SUM(factor.factored_hours) + 
   CASE WHEN factor.job_title IN ('Lecturer', 'Senior Lecturer', 'Professor') THEN admin.administration_hours / eligible.num_teachers ELSE 0 END + 
   CASE WHEN factor.job_title IN ('Lecturer', 'Senior Lecturer', 'Professor') THEN admin.examination_hours / eligible.num_teachers ELSE 0 END, 2
   ) AS total_hours
FROM factored_hours_per_employee AS factor
JOIN  course_instance AS instance ON instance.instance_id = factor.instance_id
JOIN course_layout AS layout ON instance.course_layout_id = layout.id
JOIN admin_exam_hours AS admin ON admin.instance_id = factor.instance_id
JOIN eligible_teacher_count AS eligible ON eligible.instance_id = factor.instance_id
WHERE admin.study_year = '2025'
GROUP BY
	layout.course_code,
	factor.instance_id,
	factor.hp,
    admin.study_period,
	factor.employee_name,
	factor.job_title,
	admin.administration_hours,
	admin.examination_hours,
	eligible.num_teachers;

CREATE VIEW allocated_courses_per_teacher AS
SELECT
    employee_title_name.employee_id,
    employee_title_name.employee_name,
    instance.study_period AS period,
    COUNT(DISTINCT instance.instance_id) AS no_of_courses
FROM employee_planned_activity AS employee_planned
JOIN planned_activity AS planned
  ON employee_planned.planned_activity_id = planned.id
JOIN course_instance AS instance
ON planned.course_instance_id = instance.id
JOIN employee_title_and_name AS employee_title_name
    ON employee_title_name.employee_id = employee_planned.employee_id
WHERE instance.study_year = '2025'
AND instance.study_period = 'P1'
GROUP BY
   employee_title_name.employee_id,
   employee_title_name.employee_name,
   instance.study_period;





